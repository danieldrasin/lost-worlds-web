<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lost Worlds ‚Äî Battle Demo</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    color: #fff;
    overflow: hidden;
  }

  .demo-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    text-align: center;
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0;
    animation: fadeIn 0.8s ease forwards;
  }

  .demo-subtitle {
    font-size: 0.9rem;
    color: #94a3b8;
    margin-bottom: 1.5rem;
    text-align: center;
    opacity: 0;
    animation: fadeIn 0.8s 0.3s ease forwards;
  }

  .phones-container {
    display: flex;
    gap: 2.5rem;
    align-items: flex-start;
    opacity: 0;
    animation: fadeIn 0.8s 0.5s ease forwards;
  }

  .player-label {
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .player-label.p1 { color: #60a5fa; }
  .player-label.p2 { color: #f87171; }

  /* Phone frame */
  .phone {
    width: 280px;
    height: 560px;
    border-radius: 32px;
    background: #1a1a2e;
    border: 3px solid #333;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 0 2px rgba(255,255,255,0.05);
    position: relative;
    overflow: hidden;
  }

  .phone-notch {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 24px;
    background: #1a1a2e;
    border-radius: 0 0 16px 16px;
    z-index: 100;
  }

  .phone-screen {
    position: absolute;
    top: 8px;
    left: 8px;
    right: 8px;
    bottom: 8px;
    border-radius: 24px;
    background: #111827;
    overflow: hidden;
  }

  /* Status bar */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 28px 10px 6px;
    background: #1f2937;
    font-size: 0.65rem;
    border-bottom: 1px solid #374151;
  }

  .hp-section {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }

  .hp-label {
    font-weight: 600;
    font-size: 0.6rem;
  }
  .hp-label.blue { color: #60a5fa; }
  .hp-label.red { color: #f87171; }

  .hp-bar-bg {
    height: 4px;
    background: #374151;
    border-radius: 2px;
    overflow: hidden;
  }

  .hp-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.6s ease;
  }
  .hp-bar-fill.blue { background: #3b82f6; }
  .hp-bar-fill.red { background: #ef4444; }

  .round-badge {
    background: #374151;
    color: #9ca3af;
    padding: 2px 8px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.6rem;
    margin: 0 6px;
    white-space: nowrap;
  }

  /* Screen content area */
  .screen-content {
    height: calc(100% - 46px);
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Move selection screen */
  .move-screen {
    padding: 10px;
    display: flex;
    flex-direction: column;
    height: 100%;
    opacity: 0;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: opacity 0.4s ease;
  }
  .move-screen.active { opacity: 1; z-index: 2; }

  .move-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #e5e7eb;
    margin-bottom: 6px;
  }

  .move-category {
    font-size: 0.55rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin: 4px 0 2px;
    font-weight: 600;
  }

  .move-btn {
    display: flex;
    align-items: center;
    padding: 5px 8px;
    margin: 2px 0;
    background: #1f2937;
    border-radius: 6px;
    font-size: 0.65rem;
    color: #d1d5db;
    border-left: 3px solid #6b7280;
    transition: all 0.2s;
    cursor: pointer;
  }

  .move-btn.swing { border-left-color: #dc2626; }
  .move-btn.thrust { border-left-color: #2563eb; }
  .move-btn.block { border-left-color: #16a34a; }
  .move-btn.special { border-left-color: #ea580c; }
  .move-btn.ext { border-left-color: #eab308; }

  .move-btn.selected {
    box-shadow: 0 0 0 2px #eab308;
    background: #292524;
  }

  .move-btn .mod {
    margin-left: auto;
    font-size: 0.55rem;
    color: #9ca3af;
  }

  /* Waiting overlay */
  .waiting-banner {
    background: #854d0e;
    color: #fef08a;
    padding: 6px 10px;
    text-align: center;
    font-size: 0.65rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .waiting-banner.active { opacity: 1; }

  .spinner {
    width: 12px; height: 12px;
    border: 2px solid transparent;
    border-top-color: #fef08a;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* Picture page screen */
  .picture-screen {
    display: flex;
    flex-direction: column;
    height: 100%;
    opacity: 0;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: opacity 0.4s ease;
  }
  .picture-screen.active { opacity: 1; z-index: 2; }

  .pic-header {
    background: #374151;
    padding: 6px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .pic-char-name {
    font-size: 0.7rem;
    font-weight: 700;
    color: #fff;
  }

  .pic-label {
    font-size: 0.55rem;
    color: #9ca3af;
  }

  .pic-image-area {
    flex: 1;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    background: #111827;
    padding: 6px;
    overflow: hidden;
  }

  .pic-image-area img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
    object-position: top;
    border-radius: 6px;
  }

  .pic-result {
    padding: 8px 10px;
    background: #1f2937;
    border-top: 1px solid #374151;
  }

  .pic-result-title {
    font-size: 0.7rem;
    font-weight: 700;
    color: #fff;
  }

  .pic-result-damage {
    font-size: 0.9rem;
    font-weight: 800;
    color: #f87171;
    margin-top: 2px;
  }

  .pic-result-nodamage {
    font-size: 0.75rem;
    font-weight: 600;
    color: #4ade80;
    margin-top: 2px;
  }

  .pic-exchange-summary {
    padding: 6px 10px;
    background: #111827;
    font-size: 0.6rem;
    color: #9ca3af;
    border-top: 1px solid #1f2937;
  }

  .exchange-line {
    display: flex;
    justify-content: space-between;
    padding: 2px 0;
  }
  .exchange-line .name { font-weight: 600; }
  .exchange-line .name.blue { color: #60a5fa; }
  .exchange-line .name.red { color: #f87171; }

  /* Tab bar */
  .tab-bar {
    display: flex;
    background: #1f2937;
    border-top: 1px solid #374151;
    padding: 4px 0 6px;
  }

  .tab {
    flex: 1;
    text-align: center;
    font-size: 0.55rem;
    color: #6b7280;
    padding: 3px 0;
    cursor: pointer;
  }
  .tab.active { color: #fff; }
  .tab .tab-icon { font-size: 0.85rem; display: block; }
  .tab.pulse .tab-icon {
    animation: tabPulse 1.5s ease infinite;
  }

  /* Finger tap indicator */
  .finger-tap {
    position: absolute;
    width: 36px;
    height: 36px;
    pointer-events: none;
    z-index: 200;
    opacity: 0;
  }

  .finger-tap svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  }

  .finger-tap.tapping {
    animation: fingerTap 0.5s ease forwards;
  }

  .finger-tap.moving {
    transition: top 0.3s ease, left 0.3s ease;
  }

  /* Ripple on tap */
  .tap-ripple {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 165, 0, 0.7);
    pointer-events: none;
    z-index: 199;
    opacity: 0;
  }
  .tap-ripple.active {
    animation: ripple 0.6s ease forwards;
  }

  /* Intro overlay */
  .intro-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(17, 24, 39, 0.95);
    z-index: 50;
    transition: opacity 0.5s ease;
  }
  .intro-overlay.hidden { opacity: 0; pointer-events: none; }

  .intro-vs {
    font-size: 2rem;
    font-weight: 900;
    color: #fbbf24;
    text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
  }

  .intro-char {
    font-size: 1rem;
    font-weight: 700;
    color: #e5e7eb;
    margin: 4px 0;
  }

  /* Progress bar at bottom */
  .progress-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6, #a78bfa, #f472b6);
    transition: width 0.3s linear;
    z-index: 1000;
  }

  /* Play button */
  .play-btn {
    margin-top: 1.5rem;
    padding: 12px 36px;
    background: linear-gradient(135deg, #3b82f6, #6366f1);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
    transition: transform 0.15s, box-shadow 0.15s;
    opacity: 0;
    animation: fadeIn 0.8s 0.8s ease forwards;
  }
  .play-btn:hover { transform: scale(1.05); box-shadow: 0 6px 30px rgba(99, 102, 241, 0.5); }
  .play-btn:active { transform: scale(0.97); }
  .play-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Animations */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes tabPulse { 0%, 100% { text-shadow: none; } 50% { text-shadow: 0 0 8px #eab308; } }
  @keyframes fingerTap {
    0% { opacity: 0.8; transform: scale(1); }
    30% { opacity: 1; transform: scale(0.85) translateY(3px); }
    60% { opacity: 1; transform: scale(0.9) translateY(1px); }
    100% { opacity: 0; transform: scale(1); }
  }
  @keyframes ripple {
    0% { opacity: 0.8; transform: scale(0.5); }
    100% { opacity: 0; transform: scale(1.8); }
  }
  @keyframes damageFlash {
    0%, 100% { background-color: #111827; }
    50% { background-color: #450a0a; }
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="demo-title">Lost Worlds</div>
<div class="demo-subtitle">Combat Book Game ‚Äî Digital Edition</div>

<div class="phones-container">
  <!-- Player 1: Man in Chainmail -->
  <div>
    <div class="player-label p1">Player 1 ‚Äî Man in Chainmail</div>
    <div class="phone" id="phone1">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <div class="status-bar">
          <div class="hp-section">
            <div class="hp-label blue">Man in Chainmail</div>
            <div class="hp-bar-bg"><div class="hp-bar-fill blue" id="p1-hp-bar" style="width: 100%"></div></div>
          </div>
          <div class="round-badge" id="p1-round">R1</div>
          <div class="hp-section" style="text-align: right">
            <div class="hp-label red">Hill Troll</div>
            <div class="hp-bar-bg"><div class="hp-bar-fill red" id="p1-opp-hp-bar" style="width: 100%"></div></div>
          </div>
        </div>
        <div class="screen-content" id="p1-content">
          <!-- Screens inserted by JS -->
        </div>
        <div class="tab-bar">
          <div class="tab" id="p1-tab-view"><span class="tab-icon">üëÅÔ∏è</span>View</div>
          <div class="tab active" id="p1-tab-move"><span class="tab-icon">‚öîÔ∏è</span>Move</div>
          <div class="tab" id="p1-tab-history"><span class="tab-icon">üìú</span>Log</div>
        </div>
      </div>
      <div class="finger-tap" id="finger1">
        <svg viewBox="0 0 48 48" fill="none">
          <path d="M24 4C18 4 14 9 14 14v8l-4 2c-2 1-3 3-3 5v6c0 5 4 9 9 9h8c5 0 9-4 9-9V18c0-2-2-4-4-4h-1V10c0-3-2-6-4-6z" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="tap-ripple" id="ripple1"></div>
    </div>
  </div>

  <!-- Player 2: Hill Troll -->
  <div>
    <div class="player-label p2">Player 2 ‚Äî Hill Troll</div>
    <div class="phone" id="phone2">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <div class="status-bar">
          <div class="hp-section">
            <div class="hp-label blue">Hill Troll</div>
            <div class="hp-bar-bg"><div class="hp-bar-fill blue" id="p2-hp-bar" style="width: 100%"></div></div>
          </div>
          <div class="round-badge" id="p2-round">R1</div>
          <div class="hp-section" style="text-align: right">
            <div class="hp-label red">Man in Chainmail</div>
            <div class="hp-bar-bg"><div class="hp-bar-fill red" id="p2-opp-hp-bar" style="width: 100%"></div></div>
          </div>
        </div>
        <div class="screen-content" id="p2-content">
          <!-- Screens inserted by JS -->
        </div>
        <div class="tab-bar">
          <div class="tab" id="p2-tab-view"><span class="tab-icon">üëÅÔ∏è</span>View</div>
          <div class="tab active" id="p2-tab-move"><span class="tab-icon">‚öîÔ∏è</span>Move</div>
          <div class="tab" id="p2-tab-history"><span class="tab-icon">üìú</span>Log</div>
        </div>
      </div>
      <div class="finger-tap" id="finger2">
        <svg viewBox="0 0 48 48" fill="none">
          <path d="M24 4C18 4 14 9 14 14v8l-4 2c-2 1-3 3-3 5v6c0 5 4 9 9 9h8c5 0 9-4 9-9V18c0-2-2-4-4-4h-1V10c0-3-2-6-4-6z" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="tap-ripple" id="ripple2"></div>
    </div>
  </div>
</div>

<button class="play-btn" id="playBtn" onclick="startDemo()">‚ñ∂  Play Demo</button>

<div class="progress-bar" id="progressBar" style="width: 0%"></div>

<script>
const IMG_BASE = 'https://lost-worlds-web.vercel.app/images';
const MC_IMGS = `${IMG_BASE}/man-in-chainmail`;
const HT_IMGS = `${IMG_BASE}/hill-troll`;

// Audio context (created on user interaction)
let audioCtx = null;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playTapSound() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(800, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.08);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  o.start(audioCtx.currentTime);
  o.stop(audioCtx.currentTime + 0.1);
}

function playSwordClash() {
  if (!audioCtx) return;
  const bufferSize = audioCtx.sampleRate * 0.3;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.04));
  }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;

  const hp = audioCtx.createBiquadFilter();
  hp.type = 'highpass';
  hp.frequency.value = 2000;

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.3, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);

  src.connect(hp); hp.connect(g); g.connect(audioCtx.destination);
  src.start();
}

function playHitSound() {
  if (!audioCtx) return;
  // Thud
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(120, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.2);
  g.gain.setValueAtTime(0.4, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
  o.start(); o.stop(audioCtx.currentTime + 0.25);

  // Noise layer
  const bufSize = audioCtx.sampleRate * 0.15;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.03));
  const ns = audioCtx.createBufferSource();
  ns.buffer = buf;
  const ng = audioCtx.createGain();
  ng.gain.setValueAtTime(0.2, audioCtx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
  ns.connect(ng); ng.connect(audioCtx.destination);
  ns.start();
}

function playChargeSound() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(80, audioCtx.currentTime);
  o.frequency.linearRampToValueAtTime(200, audioCtx.currentTime + 0.4);
  g.gain.setValueAtTime(0.12, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.18, audioCtx.currentTime + 0.3);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
  o.start(); o.stop(audioCtx.currentTime + 0.5);
}

let bgMusicNodes = null;
function startBgMusic() {
  if (!audioCtx || bgMusicNodes) return;
  // Simple ambient drone
  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o1.type = 'sine'; o1.frequency.value = 55;
  o2.type = 'sine'; o2.frequency.value = 82.5;

  o1.connect(g); o2.connect(g);
  g.gain.value = 0;
  g.connect(audioCtx.destination);

  o1.start(); o2.start();
  g.gain.linearRampToValueAtTime(0.06, audioCtx.currentTime + 2);
  bgMusicNodes = { o1, o2, g };
}

function stopBgMusic() {
  if (!bgMusicNodes) return;
  const { o1, o2, g } = bgMusicNodes;
  g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
  setTimeout(() => { o1.stop(); o2.stop(); }, 2000);
  bgMusicNodes = null;
}

// ===== Demo state =====
const TOTAL_DURATION = 30000; // 30 seconds

function showMoveScreen(phone, moves, selectedIndex = -1) {
  const content = document.getElementById(`${phone}-content`);
  content.innerHTML = '';

  const screen = document.createElement('div');
  screen.className = 'move-screen active';
  screen.id = `${phone}-move-screen`;

  const title = document.createElement('div');
  title.className = 'move-title';
  title.textContent = '‚öîÔ∏è Your Moves';
  screen.appendChild(title);

  moves.forEach((group, gi) => {
    const cat = document.createElement('div');
    cat.className = 'move-category';
    cat.textContent = group.category;
    screen.appendChild(cat);

    group.moves.forEach((m, mi) => {
      const btn = document.createElement('div');
      btn.className = `move-btn ${group.type}`;
      const globalIdx = moves.slice(0, gi).reduce((s, g) => s + g.moves.length, 0) + mi;
      if (globalIdx === selectedIndex) btn.classList.add('selected');
      btn.id = `${phone}-move-${globalIdx}`;
      btn.innerHTML = `${m.name}<span class="mod">${m.mod}</span>`;
      screen.appendChild(btn);
    });
  });

  content.appendChild(screen);

  // Update tabs
  document.getElementById(`${phone}-tab-move`).classList.add('active');
  document.getElementById(`${phone}-tab-view`).classList.remove('active');
}

function showWaitingBanner(phone) {
  const screen = document.getElementById(`${phone}-move-screen`);
  if (!screen) return;
  const existing = screen.querySelector('.waiting-banner');
  if (existing) { existing.classList.add('active'); return; }

  const banner = document.createElement('div');
  banner.className = 'waiting-banner active';
  banner.innerHTML = '<div class="spinner"></div> Waiting for opponent...';
  screen.insertBefore(banner, screen.firstChild.nextSibling);
}

function showPictureScreen(phone, config) {
  const content = document.getElementById(`${phone}-content`);
  content.innerHTML = '';

  const screen = document.createElement('div');
  screen.className = 'picture-screen active';

  // Header
  const header = document.createElement('div');
  header.className = 'pic-header';
  header.innerHTML = `<span class="pic-char-name">${config.charName}</span><span class="pic-label">${config.label || 'What You See'}</span>`;
  screen.appendChild(header);

  // Image
  const imgArea = document.createElement('div');
  imgArea.className = 'pic-image-area';
  if (config.imgSrc) {
    const img = document.createElement('img');
    img.src = config.imgSrc;
    img.alt = config.resultTitle;
    imgArea.appendChild(img);
  }
  screen.appendChild(imgArea);

  // Result
  const result = document.createElement('div');
  result.className = 'pic-result';
  result.innerHTML = `<div class="pic-result-title">${config.resultTitle}</div>`;
  if (config.damage > 0) {
    result.innerHTML += `<div class="pic-result-damage">Takes ${config.damage} damage!</div>`;
  } else {
    result.innerHTML += `<div class="pic-result-nodamage">No damage</div>`;
  }
  screen.appendChild(result);

  // Exchange summary
  const summary = document.createElement('div');
  summary.className = 'pic-exchange-summary';
  summary.innerHTML = `
    <div class="exchange-line"><span class="name blue">${config.p1Name}</span><span>${config.p1Move}</span></div>
    <div class="exchange-line"><span class="name red">${config.p2Name}</span><span>${config.p2Move}</span></div>
  `;
  screen.appendChild(summary);

  content.appendChild(screen);

  // Update tabs
  document.getElementById(`${phone}-tab-view`).classList.add('active');
  document.getElementById(`${phone}-tab-move`).classList.remove('active');

  // Flash if damage
  if (config.damage > 0) {
    imgArea.style.animation = 'damageFlash 0.4s ease';
  }
}

function showIntro(phone, text) {
  const content = document.getElementById(`${phone}-content`);
  content.innerHTML = `
    <div class="intro-overlay" id="${phone}-intro">
      <div class="intro-char">${text}</div>
      <div class="intro-vs" style="animation: slideUp 0.5s ease forwards">‚öîÔ∏è</div>
    </div>
  `;
}

function animateFinger(phoneId, targetX, targetY, delay) {
  return new Promise(resolve => {
    setTimeout(() => {
      const phone = document.getElementById(phoneId);
      const finger = document.getElementById(phoneId === 'phone1' ? 'finger1' : 'finger2');
      const ripple = document.getElementById(phoneId === 'phone1' ? 'ripple1' : 'ripple2');

      finger.style.left = (targetX - 18) + 'px';
      finger.style.top = (targetY - 5) + 'px';
      finger.style.opacity = '0.9';

      setTimeout(() => {
        finger.className = 'finger-tap tapping';
        ripple.style.left = (targetX - 20) + 'px';
        ripple.style.top = (targetY - 20) + 'px';
        ripple.className = 'tap-ripple active';
        playTapSound();

        setTimeout(() => {
          finger.className = 'finger-tap';
          finger.style.opacity = '0';
          ripple.className = 'tap-ripple';
          resolve();
        }, 500);
      }, 200);
    }, delay);
  });
}

function setHP(phone, myHP, oppHP) {
  const myPct = Math.max(0, myHP);
  const oppPct = Math.max(0, oppHP);
  document.getElementById(`${phone}-hp-bar`).style.width = myPct + '%';
  document.getElementById(`${phone}-opp-hp-bar`).style.width = oppPct + '%';
}

function setRound(r) {
  document.getElementById('p1-round').textContent = `R${r}`;
  document.getElementById('p2-round').textContent = `R${r}`;
}

function updateProgress(elapsed) {
  const pct = Math.min(100, (elapsed / TOTAL_DURATION) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
}

// ===== MC Move Data (simplified) =====
const MC_MOVES_EXT = [
  { category: 'Extended Range', type: 'ext', moves: [
    { name: 'Charge', mod: '' },
    { name: 'Dodge', mod: '' },
    { name: 'Jump Back', mod: '' },
  ]}
];

const MC_MOVES_NORMAL = [
  { category: 'Down Swing', type: 'swing', moves: [
    { name: 'Smash', mod: '+0' },
    { name: 'Chop', mod: '+1' },
  ]},
  { category: 'Side Swing', type: 'swing', moves: [
    { name: 'Swing High', mod: '+2' },
    { name: 'Swing Low', mod: '+1' },
  ]},
  { category: 'Thrust', type: 'thrust', moves: [
    { name: 'Thrust High', mod: '+3' },
    { name: 'Thrust Low', mod: '+2' },
  ]},
  { category: 'Block', type: 'block', moves: [
    { name: 'Block High', mod: '' },
    { name: 'Block Low', mod: '' },
  ]},
  { category: 'Special', type: 'special', moves: [
    { name: 'Kick', mod: '' },
    { name: 'Jump', mod: '' },
  ]},
];

const HT_MOVES_EXT = [
  { category: 'Extended Range', type: 'ext', moves: [
    { name: 'Charge', mod: '' },
    { name: 'Block & Regen', mod: '' },
    { name: 'Jump Back', mod: '' },
  ]}
];

const HT_MOVES_NORMAL = [
  { category: 'Down Swing', type: 'swing', moves: [
    { name: 'Smash', mod: '+0' },
    { name: 'Chop', mod: '+2' },
  ]},
  { category: 'Side Swing', type: 'swing', moves: [
    { name: 'Swing High', mod: '+1' },
    { name: 'Swing Low', mod: '+2' },
  ]},
  { category: 'Thrust', type: 'thrust', moves: [
    { name: 'Thrust High', mod: '+1' },
    { name: 'Thrust Low', mod: '+0' },
  ]},
  { category: 'Block', type: 'block', moves: [
    { name: 'Parry High', mod: '' },
    { name: 'Parry Low', mod: '' },
  ]},
  { category: 'Rage', type: 'special', moves: [
    { name: 'Enraged Bite', mod: '+3' },
    { name: 'Enraged Grab', mod: '+2' },
  ]},
];

// ===== BATTLE SCRIPT =====
async function startDemo() {
  const btn = document.getElementById('playBtn');
  btn.disabled = true;
  btn.textContent = 'Playing...';

  initAudio();
  startBgMusic();

  const startTime = Date.now();
  const elapsed = () => Date.now() - startTime;
  const wait = (ms) => new Promise(r => { const id = setInterval(() => updateProgress(elapsed()), 100); setTimeout(() => { clearInterval(id); r(); }, ms); });

  // -- Scene 1: Extended range start (0-2s) --
  showIntro('p1', 'Extended Range');
  showIntro('p2', 'Extended Range');
  await wait(1500);

  // -- Scene 2: Both see extended range moves (2-6s) --
  setRound(1);
  showMoveScreen('p1', MC_MOVES_EXT);
  showMoveScreen('p2', HT_MOVES_EXT);
  await wait(1000);

  // P1 taps Charge
  await animateFinger('phone1', 140, 215, 0);
  showMoveScreen('p1', MC_MOVES_EXT, 0);
  await wait(500);

  // P1 waiting
  showWaitingBanner('p1');
  await wait(800);

  // P2 taps Charge
  await animateFinger('phone2', 140, 215, 0);
  showMoveScreen('p2', HT_MOVES_EXT, 0);
  await wait(300);

  // -- Scene 3: Both charged ‚Üí picture pages (6-10s) --
  playChargeSound();
  showPictureScreen('p1', {
    charName: 'Hill Troll',
    label: 'What You See',
    imgSrc: `${HT_IMGS}/charging_color.webp`,
    resultTitle: 'Charging!',
    damage: 0,
    p1Name: 'Man in Chainmail', p1Move: 'Charge',
    p2Name: 'Hill Troll', p2Move: 'Charge',
  });
  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    label: 'What You See',
    imgSrc: `${MC_IMGS}/charging_color.webp`,
    resultTitle: 'Charging!',
    damage: 0,
    p1Name: 'Hill Troll', p1Move: 'Charge',
    p2Name: 'Man in Chainmail', p2Move: 'Charge',
  });
  await wait(3000);

  // -- Scene 4: Normal range ‚Äî Round 2 moves (10-16s) --
  setRound(2);
  showMoveScreen('p1', MC_MOVES_NORMAL);
  showMoveScreen('p2', HT_MOVES_NORMAL);
  await wait(1200);

  // P1 picks Swing High (index 2)
  await animateFinger('phone1', 140, 270, 0);
  showMoveScreen('p1', MC_MOVES_NORMAL, 2);
  await wait(600);
  showWaitingBanner('p1');
  await wait(600);

  // P2 picks Smash (index 0)
  await animateFinger('phone2', 140, 200, 0);
  showMoveScreen('p2', HT_MOVES_NORMAL, 0);
  await wait(400);

  // -- Scene 5: Round 2 results (16-22s) --
  playSwordClash();
  await wait(200);
  playHitSound();

  showPictureScreen('p1', {
    charName: 'Hill Troll',
    label: 'What You See',
    imgSrc: `${HT_IMGS}/body_wound_color.webp`,
    resultTitle: 'Body Wound!',
    damage: 4,
    p1Name: 'Man in Chainmail', p1Move: 'Swing High',
    p2Name: 'Hill Troll', p2Move: 'Smash',
  });

  // HT sees MC blocking/parrying (swing went through)
  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    label: 'What You See',
    imgSrc: `${MC_IMGS}/swinging_high_color.webp`,
    resultTitle: 'Swinging High',
    damage: 0,
    p1Name: 'Hill Troll', p1Move: 'Smash',
    p2Name: 'Man in Chainmail', p2Move: 'Swing High',
  });

  // Update HP: HT took 4 damage (assume 16 total ‚Üí 75%)
  setHP('p1', 100, 75);
  setHP('p2', 75, 100);
  await wait(3500);

  // -- Scene 6: Round 3 (22-28s) --
  setRound(3);
  showMoveScreen('p1', MC_MOVES_NORMAL);
  showMoveScreen('p2', HT_MOVES_NORMAL);
  await wait(1000);

  // P2 picks Enraged Bite (index 8)
  await animateFinger('phone2', 140, 400, 0);
  showMoveScreen('p2', HT_MOVES_NORMAL, 8);
  await wait(500);
  showWaitingBanner('p2');
  await wait(500);

  // P1 picks Thrust High (index 4)
  await animateFinger('phone1', 140, 310, 0);
  showMoveScreen('p1', MC_MOVES_NORMAL, 4);
  await wait(300);

  // -- Scene 7: Round 3 results (28-30s) --
  playSwordClash();
  await wait(150);
  playHitSound();

  showPictureScreen('p1', {
    charName: 'Hill Troll',
    label: 'What You See',
    imgSrc: `${HT_IMGS}/enraged_bite_color.webp`,
    resultTitle: 'Enraged Bite!',
    damage: 3,
    p1Name: 'Man in Chainmail', p1Move: 'Thrust High',
    p2Name: 'Hill Troll', p2Move: 'Enraged Bite',
  });

  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    label: 'What You See',
    imgSrc: `${MC_IMGS}/thrusting_high_color.webp`,
    resultTitle: 'Thrusting High',
    damage: 5,
    p1Name: 'Hill Troll', p1Move: 'Enraged Bite',
    p2Name: 'Man in Chainmail', p2Move: 'Thrust High',
  });

  // Both took damage
  setHP('p1', 81, 44);  // MC took 3 ‚Üí ~81%, HT took 5 more ‚Üí ~44%
  setHP('p2', 44, 81);

  await wait(2500);

  // End
  stopBgMusic();
  updateProgress(TOTAL_DURATION);
  btn.textContent = '‚ñ∂  Replay';
  btn.disabled = false;
}
</script>
</body>
</html>
