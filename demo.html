<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lost Worlds ‚Äî Battle Demo</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    color: #fff;
    overflow: hidden;
  }

  .demo-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    text-align: center;
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0;
    animation: fadeIn 0.8s ease forwards;
  }

  .demo-subtitle {
    font-size: 0.9rem;
    color: #94a3b8;
    margin-bottom: 1.5rem;
    text-align: center;
    opacity: 0;
    animation: fadeIn 0.8s 0.3s ease forwards;
  }

  .phones-container {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    opacity: 0;
    animation: fadeIn 0.8s 0.5s ease forwards;
  }

  .player-label {
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .player-label.p1 { color: #60a5fa; }
  .player-label.p2 { color: #f87171; }

  /* Phone frame */
  .phone {
    width: min(230px, 44vw);
    height: min(480px, 92vw);
    border-radius: 32px;
    background: #1a1a2e;
    border: 3px solid #333;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 0 2px rgba(255,255,255,0.05);
    position: relative;
    overflow: hidden;
  }

  .phone-notch {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 22px;
    background: #1a1a2e;
    border-radius: 0 0 14px 14px;
    z-index: 100;
  }

  .phone-screen {
    position: absolute;
    top: 8px; left: 8px; right: 8px; bottom: 8px;
    border-radius: 24px;
    background: #111827;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ===== Status bar (matches real app) ===== */
  .status-bar {
    display: flex;
    align-items: center;
    padding: 26px 8px 5px;
    background: #1f2937;
    border-bottom: 1px solid #374151;
    gap: 4px;
    flex-shrink: 0;
  }

  .hp-group {
    display: flex;
    align-items: center;
    gap: 3px;
    flex: 1;
    min-width: 0;
  }
  .hp-group.right { justify-content: flex-end; }

  .hp-name {
    font-weight: 700;
    font-size: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 42px;
  }
  .hp-name.blue { color: #60a5fa; }
  .hp-name.red { color: #f87171; }

  .hp-bar-bg {
    width: 28px;
    height: 3px;
    background: #4b5563;
    border-radius: 2px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .hp-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.6s ease;
  }
  .hp-bar-fill.blue { background: #3b82f6; }
  .hp-bar-fill.red { background: #ef4444; }
  .hp-bar-fill.yellow { background: #eab308; }

  .hp-num {
    font-size: 0.5rem;
    font-weight: 700;
    color: #fff;
    font-family: 'SF Mono', 'Menlo', monospace;
    flex-shrink: 0;
  }

  .round-badge {
    color: #9ca3af;
    font-weight: 700;
    font-size: 0.5rem;
    flex-shrink: 0;
    margin: 0 2px;
  }

  .menu-x {
    color: #6b7280;
    font-size: 0.6rem;
    margin-left: 1px;
    flex-shrink: 0;
  }

  /* ===== Screen content ===== */
  .screen-content {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  /* ===== Move selection (matches real app: pill chips in flex-wrap rows) ===== */
  .move-screen {
    padding: 8px 6px;
    overflow-y: auto;
    height: 100%;
    opacity: 0;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: opacity 0.4s ease;
  }
  .move-screen.active { opacity: 1; z-index: 2; }

  .move-screen::-webkit-scrollbar { width: 3px; }
  .move-screen::-webkit-scrollbar-track { background: transparent; }
  .move-screen::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }

  .move-title {
    font-size: 0.65rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 6px;
    text-align: center;
  }

  .move-category-label {
    font-size: 0.5rem;
    color: #e5e7eb;
    font-weight: 700;
    margin: 5px 0 2px;
  }

  .move-row {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
  }

  .move-chip {
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    background: #374151;
    border: 1px solid #4b5563;
    border-radius: 12px;
    font-size: 0.5rem;
    color: #fff;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .move-chip .mod {
    opacity: 0.7;
    margin-left: 2px;
  }

  .move-chip.selected {
    box-shadow: 0 0 0 2px #eab308;
    background: #1c1917;
  }

  .move-chip.disabled {
    background: #1f2937;
    border-color: #374151;
    color: #6b7280;
    text-decoration: line-through;
    cursor: not-allowed;
  }

  /* ===== Waiting banner ===== */
  .waiting-banner {
    background: #854d0e;
    color: #fef08a;
    padding: 4px 8px;
    text-align: center;
    font-size: 0.55rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    border-radius: 4px;
    margin-bottom: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .waiting-banner.active { opacity: 1; }

  .spinner {
    width: 10px; height: 10px;
    border: 2px solid transparent;
    border-top-color: #fef08a;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* ===== Picture page (matches real app) ===== */
  .picture-screen {
    display: flex;
    flex-direction: column;
    height: 100%;
    opacity: 0;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: opacity 0.4s ease;
  }
  .picture-screen.active { opacity: 1; z-index: 2; }

  .pic-section-label {
    font-size: 0.55rem;
    font-weight: 700;
    color: #fff;
    padding: 4px 8px 2px;
    background: #111827;
  }
  .pic-section-label span {
    font-weight: 400;
    color: #9ca3af;
    font-size: 0.45rem;
  }

  .pic-header {
    background: #374151;
    padding: 4px 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .pic-char-name {
    font-size: 0.6rem;
    font-weight: 700;
    color: #fff;
  }

  .pic-toggle {
    display: flex;
    gap: 3px;
  }

  .pic-toggle-btn {
    padding: 2px 5px;
    font-size: 0.4rem;
    font-weight: 600;
    border-radius: 3px;
    border: none;
    cursor: pointer;
  }
  .pic-toggle-btn.bw { background: #6b7280; color: #fff; }
  .pic-toggle-btn.color { background: #f97316; color: #fff; }

  .pic-image-area {
    flex: 1;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    background: #1f2937;
    overflow: hidden;
    min-height: 0;
  }

  .pic-image-area img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
    object-position: top;
  }

  .pic-result {
    padding: 5px 8px;
    background: #111827;
    text-align: center;
    flex-shrink: 0;
  }

  .pic-result-title {
    font-size: 0.6rem;
    font-weight: 700;
    color: #fff;
  }

  .pic-result-damage {
    font-size: 0.75rem;
    font-weight: 800;
    color: #f87171;
  }

  .pic-result-nodamage {
    font-size: 0.6rem;
    font-weight: 600;
    color: #4ade80;
  }

  .pic-exchange {
    padding: 4px 8px;
    background: #111827;
    font-size: 0.45rem;
    text-align: center;
    color: #9ca3af;
    border-top: 1px solid #1f2937;
    flex-shrink: 0;
  }

  .pic-exchange .you { color: #60a5fa; font-weight: 600; }
  .pic-exchange .opp { color: #f87171; font-weight: 600; }
  .pic-exchange .move-name { color: #fff; font-weight: 700; }
  .pic-exchange .dmg-red { color: #f87171; }
  .pic-exchange .dmg-green { color: #4ade80; }

  /* ===== Tab bar (matches real app) ===== */
  .tab-bar {
    display: flex;
    background: #1f2937;
    border-top: 1px solid #374151;
    flex-shrink: 0;
  }

  .tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 5px 0 4px;
    font-size: 0.4rem;
    color: #9ca3af;
    cursor: pointer;
    position: relative;
    transition: all 0.15s;
  }
  .tab.active {
    color: #fff;
    background: #374151;
  }
  .tab .tab-icon { font-size: 0.7rem; }
  .tab .tab-label { margin-top: 1px; }

  .tab.highlight {
    color: #eab308;
    border-top: 2px solid #eab308;
    animation: tabHighlight 2s ease-in-out infinite;
  }

  .tab .badge {
    position: absolute;
    top: 2px;
    right: calc(50% - 14px);
    background: #22c55e;
    color: #fff;
    font-size: 0.35rem;
    font-weight: 700;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ===== Finger tap ===== */
  .finger-tap {
    position: absolute;
    width: 32px;
    height: 32px;
    pointer-events: none;
    z-index: 200;
    opacity: 0;
  }

  .finger-tap svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

  .finger-tap.tapping {
    animation: fingerTap 0.5s ease forwards;
  }

  .tap-ripple {
    position: absolute;
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 2px solid rgba(255, 165, 0, 0.7);
    pointer-events: none;
    z-index: 199;
    opacity: 0;
  }
  .tap-ripple.active { animation: ripple 0.6s ease forwards; }

  /* ===== Progress bar ===== */
  .progress-bar {
    position: fixed;
    bottom: 0; left: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6, #a78bfa, #f472b6);
    transition: width 0.3s linear;
    z-index: 1000;
  }

  /* ===== Play button ===== */
  .play-btn {
    margin-top: 1.5rem;
    padding: 12px 36px;
    background: linear-gradient(135deg, #3b82f6, #6366f1);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
    transition: transform 0.15s, box-shadow 0.15s;
    opacity: 0;
    animation: fadeIn 0.8s 0.8s ease forwards;
  }
  .play-btn:hover { transform: scale(1.05); }
  .play-btn:active { transform: scale(0.97); }
  .play-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  @media (max-width: 600px) {
    .demo-title { font-size: 1.5rem; }
    .demo-subtitle { font-size: 0.75rem; margin-bottom: 0.75rem; }
    .player-label { font-size: 0.7rem; }
    .phones-container { gap: 0.5rem; }
  }

  /* ===== Animations ===== */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fingerTap {
    0% { opacity: 0.8; transform: scale(1); }
    30% { opacity: 1; transform: scale(0.85) translateY(3px); }
    60% { opacity: 1; transform: scale(0.9) translateY(1px); }
    100% { opacity: 0; transform: scale(1); }
  }
  @keyframes ripple {
    0% { opacity: 0.8; transform: scale(0.5); }
    100% { opacity: 0; transform: scale(1.8); }
  }
  @keyframes damageFlash {
    0%, 100% { background-color: #1f2937; }
    50% { background-color: #450a0a; }
  }
  @keyframes tabHighlight {
    0%, 100% { box-shadow: inset 0 0 0 0 transparent; }
    50% { box-shadow: inset 0 0 12px 0 rgba(234, 179, 8, 0.15); }
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="demo-title">Lost Worlds</div>
<div class="demo-subtitle">Combat Book Game ‚Äî Digital Edition</div>

<div class="phones-container">
  <!-- Player 1: Man in Chainmail -->
  <div>
    <div class="player-label p1">Player 1 ‚Äî Man in Chainmail</div>
    <div class="phone" id="phone1">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <div class="status-bar">
          <div class="hp-group">
            <span class="hp-name blue">Man in Chai...</span>
            <div class="hp-bar-bg"><div class="hp-bar-fill blue" id="p1-hp-bar" style="width:100%"></div></div>
            <span class="hp-num" id="p1-hp-num">12</span>
          </div>
          <span class="round-badge" id="p1-round">R1</span>
          <span class="menu-x">‚úï</span>
          <div class="hp-group right">
            <span class="hp-num" id="p1-opp-hp-num">35</span>
            <div class="hp-bar-bg"><div class="hp-bar-fill red" id="p1-opp-hp-bar" style="width:100%"></div></div>
            <span class="hp-name red">Hill Troll wi...</span>
          </div>
        </div>
        <div class="screen-content" id="p1-content"></div>
        <div class="tab-bar" id="p1-tabs">
          <div class="tab" id="p1-tab-view"><span class="tab-icon">üëÅÔ∏è</span><span class="tab-label">View</span></div>
          <div class="tab active highlight" id="p1-tab-move"><span class="tab-icon">‚öîÔ∏è</span><span class="tab-label">Move</span></div>
          <div class="tab" id="p1-tab-history"><span class="tab-icon">üìú</span><span class="tab-label">History</span></div>
        </div>
      </div>
      <div class="finger-tap" id="finger1"><svg viewBox="0 0 48 48" fill="none"><path d="M24 4C18 4 14 9 14 14v8l-4 2c-2 1-3 3-3 5v6c0 5 4 9 9 9h8c5 0 9-4 9-9V18c0-2-2-4-4-4h-1V10c0-3-2-6-4-6z" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="1.5"/></svg></div>
      <div class="tap-ripple" id="ripple1"></div>
    </div>
  </div>

  <!-- Player 2: Hill Troll -->
  <div>
    <div class="player-label p2">Player 2 ‚Äî Hill Troll</div>
    <div class="phone" id="phone2">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <div class="status-bar">
          <div class="hp-group">
            <span class="hp-name blue">Hill Troll wi...</span>
            <div class="hp-bar-bg"><div class="hp-bar-fill blue" id="p2-hp-bar" style="width:100%"></div></div>
            <span class="hp-num" id="p2-hp-num">35</span>
          </div>
          <span class="round-badge" id="p2-round">R1</span>
          <span class="menu-x">‚úï</span>
          <div class="hp-group right">
            <span class="hp-num" id="p2-opp-hp-num">12</span>
            <div class="hp-bar-bg"><div class="hp-bar-fill red" id="p2-opp-hp-bar" style="width:100%"></div></div>
            <span class="hp-name red">Man in Chai...</span>
          </div>
        </div>
        <div class="screen-content" id="p2-content"></div>
        <div class="tab-bar" id="p2-tabs">
          <div class="tab" id="p2-tab-view"><span class="tab-icon">üëÅÔ∏è</span><span class="tab-label">View</span></div>
          <div class="tab active highlight" id="p2-tab-move"><span class="tab-icon">‚öîÔ∏è</span><span class="tab-label">Move</span></div>
          <div class="tab" id="p2-tab-history"><span class="tab-icon">üìú</span><span class="tab-label">History</span></div>
        </div>
      </div>
      <div class="finger-tap" id="finger2"><svg viewBox="0 0 48 48" fill="none"><path d="M24 4C18 4 14 9 14 14v8l-4 2c-2 1-3 3-3 5v6c0 5 4 9 9 9h8c5 0 9-4 9-9V18c0-2-2-4-4-4h-1V10c0-3-2-6-4-6z" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="1.5"/></svg></div>
      <div class="tap-ripple" id="ripple2"></div>
    </div>
  </div>
</div>

<button class="play-btn" id="playBtn" onclick="startDemo()">‚ñ∂  Play Demo</button>
<div class="progress-bar" id="progressBar" style="width: 0%"></div>

<script>
const IMG_BASE = 'https://lost-worlds-web.vercel.app/images';
const MC_IMGS = `${IMG_BASE}/man-in-chainmail`;
const HT_IMGS = `${IMG_BASE}/hill-troll`;

// ===== Audio =====
let audioCtx = null;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playTapSound() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(800, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.08);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1);
}

function playSwordClash() {
  if (!audioCtx) return;
  const bufferSize = audioCtx.sampleRate * 0.3;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.04));
  }
  const src = audioCtx.createBufferSource(); src.buffer = buffer;
  const hp = audioCtx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 2000;
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.3, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
  src.connect(hp); hp.connect(g); g.connect(audioCtx.destination); src.start();
}

function playHitSound() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sine';
  o.frequency.setValueAtTime(120, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.2);
  g.gain.setValueAtTime(0.4, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
  o.start(); o.stop(audioCtx.currentTime + 0.25);
  const bs = audioCtx.sampleRate * 0.15;
  const b = audioCtx.createBuffer(1, bs, audioCtx.sampleRate);
  const d = b.getChannelData(0);
  for (let i = 0; i < bs; i++) d[i] = (Math.random()*2-1) * Math.exp(-i/(audioCtx.sampleRate*0.03));
  const ns = audioCtx.createBufferSource(); ns.buffer = b;
  const ng = audioCtx.createGain();
  ng.gain.setValueAtTime(0.2, audioCtx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
  ns.connect(ng); ng.connect(audioCtx.destination); ns.start();
}

function playChargeSound() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(80, audioCtx.currentTime);
  o.frequency.linearRampToValueAtTime(200, audioCtx.currentTime + 0.4);
  g.gain.setValueAtTime(0.12, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.18, audioCtx.currentTime + 0.3);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
  o.start(); o.stop(audioCtx.currentTime + 0.5);
}

let bgMusicNodes = null;
function startBgMusic() {
  if (!audioCtx || bgMusicNodes) return;
  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o1.type = 'sine'; o1.frequency.value = 55;
  o2.type = 'sine'; o2.frequency.value = 82.5;
  o1.connect(g); o2.connect(g); g.gain.value = 0; g.connect(audioCtx.destination);
  o1.start(); o2.start();
  g.gain.linearRampToValueAtTime(0.06, audioCtx.currentTime + 2);
  bgMusicNodes = { o1, o2, g };
}

function stopBgMusic() {
  if (!bgMusicNodes) return;
  const { o1, o2, g } = bgMusicNodes;
  g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
  setTimeout(() => { o1.stop(); o2.stop(); }, 2000);
  bgMusicNodes = null;
}

// ===== Move data (matching real app categories and colors) =====
// MC extended range moves
const MC_EXT = [
  { cat: 'Extended', color: '#3b82f6', moves: [
    { name: 'Charge', mod: '+3' },
    { name: 'Swing High', mod: '-6' },
    { name: 'Swing Low', mod: '-6' },
    { name: 'Thrust High', mod: '-5' },
    { name: 'Thrust Low', mod: '-3' },
    { name: 'Block & Close', mod: '' },
    { name: 'Dodge', mod: '' },
    { name: 'Jump Back', mod: '' },
  ]}
];

// MC normal range moves (matching real app screenshot)
const MC_NORMAL = [
  { cat: 'Down Swing', color: '#dc2626', moves: [
    { name: 'Smash', mod: '+3' },
  ]},
  { cat: 'Side Swing', color: '#dc2626', moves: [
    { name: 'Strong', mod: '+2' },
    { name: 'High', mod: '+1' },
    { name: 'Low', mod: '+1' },
  ]},
  { cat: 'Thrust', color: '#2563eb', moves: [
    { name: 'High', mod: '' },
    { name: 'Low', mod: '' },
  ]},
  { cat: 'Fake', color: '#ea580c', moves: [
    { name: 'High', mod: '' },
    { name: 'Low', mod: '' },
    { name: 'Side Swing', mod: '-1' },
    { name: 'Thrust', mod: '' },
  ]},
  { cat: 'Protected', color: '#16a34a', moves: [
    { name: 'Down Swing', mod: '+2' },
    { name: 'Side Swing', mod: '' },
    { name: 'Thrust', mod: '-1' },
  ]},
  { cat: 'Special', color: '#ea580c', moves: [
    { name: 'Kick', mod: '' },
    { name: 'Wild Swing', mod: '+2' },
    { name: 'Dislodge Weapon', mod: '-4' },
    { name: 'Retrieve Weapon', mod: '-6' },
  ]},
  { cat: 'Block', color: '#16a34a', moves: [
    { name: 'High', mod: '+1' },
    { name: 'Low', mod: '+1' },
  ]},
  { cat: 'Jump', color: '#eab308', moves: [
    { name: 'Up', mod: '' },
    { name: 'Dodge', mod: '' },
    { name: 'Duck', mod: '' },
    { name: 'Away', mod: '' },
  ]},
];

// HT extended range moves
const HT_EXT = [
  { cat: 'Extended', color: '#3b82f6', moves: [
    { name: 'Charge', mod: '+3' },
    { name: 'Swing High', mod: '-4' },
    { name: 'Swing Low', mod: '-4' },
    { name: 'Thrust High', mod: '-3' },
    { name: 'Block & Regen', mod: '' },
    { name: 'Dodge', mod: '' },
    { name: 'Jump Back', mod: '' },
  ]}
];

// HT normal range moves
const HT_NORMAL = [
  { cat: 'Down Swing', color: '#dc2626', moves: [
    { name: 'Smash', mod: '+4' },
    { name: 'Chop', mod: '+3' },
  ]},
  { cat: 'Side Swing', color: '#dc2626', moves: [
    { name: 'Strong', mod: '+3' },
    { name: 'High', mod: '+2' },
    { name: 'Low', mod: '+2' },
  ]},
  { cat: 'Thrust', color: '#2563eb', moves: [
    { name: 'High', mod: '+1' },
    { name: 'Low', mod: '' },
  ]},
  { cat: 'Rage', color: '#dc2626', moves: [
    { name: 'Bite', mod: '' },
    { name: 'Grab', mod: '' },
    { name: 'Throw', mod: '' },
  ]},
  { cat: 'Special', color: '#ea580c', moves: [
    { name: 'Kick', mod: '' },
    { name: 'Wild Swing', mod: '+3' },
  ]},
  { cat: 'Block', color: '#16a34a', moves: [
    { name: 'High', mod: '+1' },
    { name: 'Low', mod: '+1' },
  ]},
  { cat: 'Jump', color: '#eab308', moves: [
    { name: 'Up', mod: '' },
    { name: 'Dodge', mod: '' },
    { name: 'Duck', mod: '' },
    { name: 'Away', mod: '' },
  ]},
];

// ===== UI functions =====
const TOTAL_DURATION = 30000;

function showMoveScreen(phone, moveGroups, selectedCat = -1, selectedIdx = -1) {
  const content = document.getElementById(`${phone}-content`);
  content.innerHTML = '';

  const screen = document.createElement('div');
  screen.className = 'move-screen active';
  screen.id = `${phone}-move-screen`;

  const title = document.createElement('div');
  title.className = 'move-title';
  title.textContent = 'Your Moves';
  screen.appendChild(title);

  moveGroups.forEach((group, gi) => {
    const catLabel = document.createElement('div');
    catLabel.className = 'move-category-label';
    catLabel.textContent = group.cat;
    screen.appendChild(catLabel);

    const row = document.createElement('div');
    row.className = 'move-row';

    group.moves.forEach((m, mi) => {
      const chip = document.createElement('div');
      chip.className = 'move-chip';
      if (group.cat === 'Extended') {
        chip.style.borderLeftWidth = '3px';
        chip.style.borderLeftColor = group.color;
      }
      if (gi === selectedCat && mi === selectedIdx) chip.classList.add('selected');
      chip.id = `${phone}-chip-${gi}-${mi}`;
      chip.innerHTML = m.mod ? `${m.name} <span class="mod">${m.mod}</span>` : m.name;
      row.appendChild(chip);
    });

    screen.appendChild(row);
  });

  content.appendChild(screen);

  // Update tab highlights
  setTab(phone, 'move');
}

function showWaitingBanner(phone) {
  const screen = document.getElementById(`${phone}-move-screen`);
  if (!screen) return;
  const existing = screen.querySelector('.waiting-banner');
  if (existing) { existing.classList.add('active'); return; }

  const banner = document.createElement('div');
  banner.className = 'waiting-banner active';
  banner.innerHTML = '<div class="spinner"></div> Waiting for opponent...';
  // Insert after title
  const title = screen.querySelector('.move-title');
  if (title && title.nextSibling) {
    screen.insertBefore(banner, title.nextSibling);
  } else {
    screen.appendChild(banner);
  }
}

function showPictureScreen(phone, config) {
  const content = document.getElementById(`${phone}-content`);
  content.innerHTML = '';

  const screen = document.createElement('div');
  screen.className = 'picture-screen active';

  // "What You See" label
  const sectionLabel = document.createElement('div');
  sectionLabel.className = 'pic-section-label';
  sectionLabel.innerHTML = `What You See <span>(Opponent's Book)</span>`;
  screen.appendChild(sectionLabel);

  // Character name header with B&W/Color toggle
  const header = document.createElement('div');
  header.className = 'pic-header';
  header.innerHTML = `
    <span class="pic-char-name">${config.charName}</span>
    <div class="pic-toggle">
      <span class="pic-toggle-btn bw">B&W</span>
      <span class="pic-toggle-btn color">Color</span>
    </div>
  `;
  screen.appendChild(header);

  // Image
  const imgArea = document.createElement('div');
  imgArea.className = 'pic-image-area';
  if (config.imgSrc) {
    const img = document.createElement('img');
    img.src = config.imgSrc;
    img.alt = config.resultTitle;
    imgArea.appendChild(img);
  }
  screen.appendChild(imgArea);

  // Result
  const result = document.createElement('div');
  result.className = 'pic-result';
  let html = `<div class="pic-result-title">${config.resultTitle}</div>`;
  if (config.damage > 0) {
    html += `<div class="pic-result-damage">Takes ${config.damage} damage!</div>`;
  } else {
    html += `<div class="pic-result-nodamage">No damage</div>`;
  }
  if (config.restriction) {
    html += `<div style="color:#eab308;font-size:0.45rem;margin-top:2px">‚ö†Ô∏è ${config.restriction}</div>`;
  }
  result.innerHTML = html;
  screen.appendChild(result);

  // Exchange summary
  const exchange = document.createElement('div');
  exchange.className = 'pic-exchange';
  exchange.innerHTML = `
    <span class="you">${config.youName}</span> <span class="move-name">${config.youMove}</span>
    vs
    <span class="opp">${config.oppName}</span> <span class="move-name">${config.oppMove}</span>
    <br/>
    <span class="${config.youDmg > 0 ? 'dmg-red' : 'dmg-green'}">You: ${config.youDmg > 0 ? '-' + config.youDmg : 'no dmg'}</span>
    ¬∑ <span class="${config.oppDmg > 0 ? 'dmg-red' : 'dmg-green'}">${config.oppLabel}: ${config.oppDmg > 0 ? '-' + config.oppDmg : 'no dmg'}</span>
  `;
  screen.appendChild(exchange);

  content.appendChild(screen);
  setTab(phone, 'view');

  if (config.damage > 0) {
    imgArea.style.animation = 'damageFlash 0.4s ease';
  }
}

function setTab(phone, active) {
  ['view', 'move', 'history'].forEach(t => {
    const tab = document.getElementById(`${phone}-tab-${t}`);
    tab.classList.remove('active', 'highlight');
    if (t === active) tab.classList.add('active');
    if (t === 'move' && active === 'move') tab.classList.add('highlight');
  });
}

function animateFinger(phoneId, targetX, targetY, delay) {
  return new Promise(resolve => {
    setTimeout(() => {
      const phone = document.getElementById(phoneId);
      const finger = document.getElementById(phoneId === 'phone1' ? 'finger1' : 'finger2');
      const ripple = document.getElementById(phoneId === 'phone1' ? 'ripple1' : 'ripple2');

      finger.style.left = (targetX - 16) + 'px';
      finger.style.top = (targetY - 5) + 'px';
      finger.style.opacity = '0.9';

      setTimeout(() => {
        finger.className = 'finger-tap tapping';
        ripple.style.left = (targetX - 18) + 'px';
        ripple.style.top = (targetY - 18) + 'px';
        ripple.className = 'tap-ripple active';
        playTapSound();

        setTimeout(() => {
          finger.className = 'finger-tap';
          finger.style.opacity = '0';
          ripple.className = 'tap-ripple';
          resolve();
        }, 500);
      }, 200);
    }, delay);
  });
}

// Animate finger to land on a specific chip element by ID
function animateFingerToChip(phoneId, playerPrefix, groupIdx, moveIdx, delay) {
  const chipId = `${playerPrefix}-chip-${groupIdx}-${moveIdx}`;
  const chip = document.getElementById(chipId);
  const phone = document.getElementById(phoneId);
  if (!chip || !phone) {
    // Fallback to center of phone
    return animateFinger(phoneId, 100, 300, delay);
  }
  const phoneRect = phone.getBoundingClientRect();
  const chipRect = chip.getBoundingClientRect();
  // Get chip center relative to the phone element
  const targetX = chipRect.left - phoneRect.left + chipRect.width / 2;
  const targetY = chipRect.top - phoneRect.top + chipRect.height / 2;
  return animateFinger(phoneId, targetX, targetY, delay);
}

function setHP(p1hp, p1max, p2hp, p2max) {
  const p1pct = Math.round((p1hp / p1max) * 100);
  const p2pct = Math.round((p2hp / p2max) * 100);

  document.getElementById('p1-hp-bar').style.width = p1pct + '%';
  document.getElementById('p1-hp-num').textContent = p1hp;
  document.getElementById('p2-opp-hp-num').textContent = p1hp;
  document.getElementById('p2-opp-hp-bar').style.width = p1pct + '%';

  document.getElementById('p2-hp-bar').style.width = p2pct + '%';
  document.getElementById('p2-hp-num').textContent = p2hp;
  document.getElementById('p1-opp-hp-num').textContent = p2hp;
  document.getElementById('p1-opp-hp-bar').style.width = p2pct + '%';

  // Color change when low
  if (p2pct <= 25) {
    document.getElementById('p2-hp-bar').className = 'hp-bar-fill red';
  } else if (p2pct <= 50) {
    document.getElementById('p2-hp-bar').className = 'hp-bar-fill yellow';
  }
}

function setRound(r) {
  document.getElementById('p1-round').textContent = `R${r}`;
  document.getElementById('p2-round').textContent = `R${r}`;
}

function updateProgress(elapsed) {
  document.getElementById('progressBar').style.width = Math.min(100, (elapsed / TOTAL_DURATION) * 100) + '%';
}

// ===== BATTLE SCRIPT =====
async function startDemo() {
  const btn = document.getElementById('playBtn');
  btn.disabled = true;
  btn.textContent = 'Playing...';

  initAudio();
  startBgMusic();

  const MC_HP = 12, HT_HP = 35;
  let mcHp = MC_HP, htHp = HT_HP;

  const startTime = Date.now();
  const elapsed = () => Date.now() - startTime;
  const wait = (ms) => new Promise(r => { const id = setInterval(() => updateProgress(elapsed()), 100); setTimeout(() => { clearInterval(id); r(); }, ms); });

  // Reset HP
  setHP(mcHp, MC_HP, htHp, HT_HP);

  // -- R1: Extended range ‚Äî both Charge (0-7s) --
  // Real app shows all moves + Extended category at bottom
  const MC_ALL_EXT = [...MC_NORMAL, ...MC_EXT];
  const HT_ALL_EXT = [...HT_NORMAL, ...HT_EXT];
  const mcExtGroupIdx = MC_NORMAL.length; // index of Extended category in combined list
  const htExtGroupIdx = HT_NORMAL.length;

  setRound(1);
  showMoveScreen('p1', MC_ALL_EXT);
  showMoveScreen('p2', HT_ALL_EXT);

  // Scroll to bottom to show Extended section, then tap
  await wait(800);
  const p1Screen = document.getElementById('p1-move-screen');
  const p2Screen = document.getElementById('p2-move-screen');
  if (p1Screen) p1Screen.scrollTo({ top: p1Screen.scrollHeight, behavior: 'smooth' });
  if (p2Screen) p2Screen.scrollTo({ top: p2Screen.scrollHeight, behavior: 'smooth' });
  await wait(600);

  // P1 taps Charge (first move in Extended group)
  await animateFingerToChip('phone1', 'p1', mcExtGroupIdx, 0, 0);
  showMoveScreen('p1', MC_ALL_EXT, mcExtGroupIdx, 0);
  const p1ScreenAfter = document.getElementById('p1-move-screen');
  if (p1ScreenAfter) p1ScreenAfter.scrollTo({ top: p1ScreenAfter.scrollHeight, behavior: 'instant' });
  await wait(500);
  showWaitingBanner('p1');
  await wait(800);

  // P2 taps Charge
  await animateFingerToChip('phone2', 'p2', htExtGroupIdx, 0, 0);
  showMoveScreen('p2', HT_ALL_EXT, htExtGroupIdx, 0);
  const p2ScreenAfter = document.getElementById('p2-move-screen');
  if (p2ScreenAfter) p2ScreenAfter.scrollTo({ top: p2ScreenAfter.scrollHeight, behavior: 'instant' });
  await wait(400);

  // Results: both charged, no damage
  playChargeSound();
  showPictureScreen('p1', {
    charName: 'Hill Troll with Club',
    imgSrc: `${HT_IMGS}/charging_color.webp`,
    resultTitle: 'Charging!',
    damage: 0,
    youName: 'You', youMove: 'Charge',
    oppName: 'Hill Troll', oppMove: 'Charge',
    youDmg: 0, oppDmg: 0, oppLabel: 'Opp',
  });
  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    imgSrc: `${MC_IMGS}/charging_color.webp`,
    resultTitle: 'Charging!',
    damage: 0,
    youName: 'You', youMove: 'Charge',
    oppName: 'Chainmail', oppMove: 'Charge',
    youDmg: 0, oppDmg: 0, oppLabel: 'Opp',
  });
  await wait(3000);

  // -- R2: Normal range ‚Äî MC Swing High, HT Smash (7-17s) --
  setRound(2);
  showMoveScreen('p1', MC_NORMAL);
  showMoveScreen('p2', HT_NORMAL);
  await wait(1200);

  // P1 picks Side Swing > High (cat 1, idx 1)
  await animateFingerToChip('phone1', 'p1', 1, 1, 0);
  showMoveScreen('p1', MC_NORMAL, 1, 1);
  await wait(500);
  showWaitingBanner('p1');
  await wait(800);

  // P2 picks Down Swing > Smash (cat 0, idx 0)
  await animateFingerToChip('phone2', 'p2', 0, 0, 0);
  showMoveScreen('p2', HT_NORMAL, 0, 0);
  await wait(400);

  // Results: MC's Swing High hit HT for 4 body damage
  playSwordClash();
  await wait(200);
  playHitSound();
  htHp -= 4;
  setHP(mcHp, MC_HP, htHp, HT_HP);

  showPictureScreen('p1', {
    charName: 'Hill Troll with Club',
    imgSrc: `${HT_IMGS}/body_wound_color.webp`,
    resultTitle: 'Body Wound!',
    damage: 4,
    youName: 'You', youMove: 'Swing High',
    oppName: 'Hill Troll', oppMove: 'Smash',
    youDmg: 0, oppDmg: 4, oppLabel: 'Opp',
  });
  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    imgSrc: `${MC_IMGS}/swinging_high_color.webp`,
    resultTitle: 'Swinging High',
    damage: 0,
    youName: 'You', youMove: 'Smash',
    oppName: 'Chainmail', oppMove: 'Swing High',
    youDmg: 4, oppDmg: 0, oppLabel: 'Opp',
  });
  await wait(3500);

  // -- R3: HT Enraged Bite, MC Thrust High (17-27s) --
  setRound(3);
  showMoveScreen('p1', MC_NORMAL);
  showMoveScreen('p2', HT_NORMAL);
  await wait(1000);

  // P2 picks Rage > Bite (cat 3, idx 0)
  await animateFingerToChip('phone2', 'p2', 3, 0, 0);
  showMoveScreen('p2', HT_NORMAL, 3, 0);
  await wait(500);
  showWaitingBanner('p2');
  await wait(600);

  // P1 picks Thrust > High (cat 2, idx 0)
  await animateFingerToChip('phone1', 'p1', 2, 0, 0);
  showMoveScreen('p1', MC_NORMAL, 2, 0);
  await wait(400);

  // Results: both take damage
  playSwordClash();
  await wait(150);
  playHitSound();
  mcHp -= 3;
  htHp -= 5;
  setHP(mcHp, MC_HP, htHp, HT_HP);

  showPictureScreen('p1', {
    charName: 'Hill Troll with Club',
    imgSrc: `${HT_IMGS}/enraged_bite_color.webp`,
    resultTitle: 'Enraged Bite!',
    damage: 3,
    youName: 'You', youMove: 'Thrust High',
    oppName: 'Hill Troll', oppMove: 'Enraged Bite',
    youDmg: 3, oppDmg: 5, oppLabel: 'Opp',
  });
  showPictureScreen('p2', {
    charName: 'Man in Chainmail',
    imgSrc: `${MC_IMGS}/thrusting_high_color.webp`,
    resultTitle: 'Thrusting High',
    damage: 5,
    youName: 'You', youMove: 'Enraged Bite',
    oppName: 'Chainmail', oppMove: 'Thrust High',
    youDmg: 5, oppDmg: 3, oppLabel: 'Opp',
  });
  await wait(3000);

  // End
  stopBgMusic();
  updateProgress(TOTAL_DURATION);
  btn.textContent = '‚ñ∂  Replay';
  btn.disabled = false;
}
</script>
</body>
</html>
