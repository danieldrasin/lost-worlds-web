<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lost Worlds - Multiplayer E2E Test Runner</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      margin: 0;
    }
    h1 { color: #4ade80; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 20px; }
    .test-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .player-frame {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
    }
    .player-frame h3 {
      background: #0f3460;
      margin: 0;
      padding: 10px;
      text-align: center;
    }
    .player-frame.player1 h3 { background: #1e40af; }
    .player-frame.player2 h3 { background: #7c3aed; }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    .log {
      background: #0d1117;
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .log-entry { margin: 5px 0; padding: 5px; border-radius: 4px; }
    .log-entry.info { background: #1e3a5f; }
    .log-entry.success { background: #166534; color: #4ade80; }
    .log-entry.error { background: #7f1d1d; color: #fca5a5; }
    .log-entry.warn { background: #78350f; color: #fcd34d; }
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .status.running { background: #1e40af; }
    .status.passed { background: #166534; }
    .status.failed { background: #7f1d1d; }
    .controls { margin-bottom: 20px; }
    button {
      background: #4ade80;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #22c55e; }
    button:disabled { background: #555; color: #888; cursor: not-allowed; }
    .results {
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }
    .test-result {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #333;
    }
    .test-result:last-child { border-bottom: none; }
    .test-result .icon { font-size: 20px; margin-right: 10px; }
    .test-result .name { flex: 1; }
    .test-result .time { color: #888; font-size: 12px; }
  </style>
</head>
<body>
  <h1>üéÆ Lost Worlds Multiplayer Test Runner</h1>
  <p class="subtitle">Automated E2E tests for multiplayer functionality</p>

  <div class="controls">
    <button id="runTests" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button id="stopTests" onclick="stopTests()" disabled>‚èπÔ∏è Stop</button>
    <span id="status" class="status">Ready</span>
  </div>

  <div class="test-container">
    <div class="player-frame player1">
      <h3>üë§ Player 1 (Host)</h3>
      <iframe id="frame1" src="about:blank"></iframe>
    </div>
    <div class="player-frame player2">
      <h3>üë§ Player 2 (Guest)</h3>
      <iframe id="frame2" src="about:blank"></iframe>
    </div>
  </div>

  <h3>üìã Test Log</h3>
  <div id="log" class="log"></div>

  <div id="results" class="results" style="display:none;">
    <h3>üìä Test Results</h3>
    <div id="resultsList"></div>
  </div>

  <script>
    const BASE_URL = 'https://lost-worlds-web.vercel.app';
    const SERVER_URL = 'https://lost-worlds-server.onrender.com';

    let running = false;
    let testResults = [];

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text, className) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = `status ${className}`;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function waitForElement(frame, selector, timeout = 10000) {
      const start = Date.now();
      while (Date.now() - start < timeout) {
        try {
          const el = frame.contentDocument.querySelector(selector);
          if (el) return el;
        } catch (e) {}
        await sleep(100);
      }
      throw new Error(`Timeout waiting for: ${selector}`);
    }

    async function waitForText(frame, text, timeout = 10000) {
      const start = Date.now();
      while (Date.now() - start < timeout) {
        try {
          if (frame.contentDocument.body.innerText.includes(text)) return true;
        } catch (e) {}
        await sleep(100);
      }
      throw new Error(`Timeout waiting for text: ${text}`);
    }

    async function clickButton(frame, text) {
      const buttons = frame.contentDocument.querySelectorAll('button');
      for (const btn of buttons) {
        if (btn.innerText.includes(text)) {
          btn.click();
          return true;
        }
      }
      throw new Error(`Button not found: ${text}`);
    }

    async function runTest(name, testFn) {
      const start = Date.now();
      try {
        log(`‚ñ∂Ô∏è Running: ${name}`);
        await testFn();
        const duration = Date.now() - start;
        log(`‚úÖ PASSED: ${name} (${duration}ms)`, 'success');
        testResults.push({ name, passed: true, duration });
        return true;
      } catch (err) {
        const duration = Date.now() - start;
        log(`‚ùå FAILED: ${name} - ${err.message}`, 'error');
        testResults.push({ name, passed: false, duration, error: err.message });
        return false;
      }
    }

    async function runAllTests() {
      if (running) return;
      running = true;
      testResults = [];

      document.getElementById('runTests').disabled = true;
      document.getElementById('stopTests').disabled = false;
      document.getElementById('results').style.display = 'none';
      document.getElementById('log').innerHTML = '';

      setStatus('Running...', 'running');

      const frame1 = document.getElementById('frame1');
      const frame2 = document.getElementById('frame2');

      // Test 1: Server Health Check
      await runTest('Server Health Check', async () => {
        const response = await fetch(`${SERVER_URL}/health`);
        if (!response.ok) throw new Error('Server not responding');
        const data = await response.json();
        if (data.status !== 'ok') throw new Error('Server unhealthy');
        log(`Server: ${data.rooms} rooms, ${data.players} players`);
      });

      if (!running) return showResults();

      // Test 2: App Loads
      await runTest('App Loads in Both Frames', async () => {
        frame1.src = BASE_URL;
        frame2.src = BASE_URL;
        await sleep(3000);
        await waitForText(frame1, 'Lost Worlds', 15000);
        await waitForText(frame2, 'Lost Worlds', 15000);
        log('Both frames loaded the app');
      });

      if (!running) return showResults();

      // Test 3: Navigate to Online Mode
      await runTest('Navigate to Online Mode', async () => {
        await clickButton(frame1, 'Online');
        await clickButton(frame2, 'Online');
        await sleep(500);
        await clickButton(frame1, 'Find Opponent');
        await clickButton(frame2, 'Find Opponent');
        await waitForText(frame1, 'Create Room', 10000);
        await waitForText(frame2, 'Create Room', 10000);
        log('Both players in multiplayer lobby');
      });

      if (!running) return showResults();

      // Test 4: Create Room
      let roomCode = '';
      await runTest('Create Room', async () => {
        await clickButton(frame1, 'Create Room');
        await waitForText(frame1, 'Share this code', 10000);
        // Find the room code (it's in a large font element)
        const codeEl = frame1.contentDocument.querySelector('.text-5xl');
        if (!codeEl) throw new Error('Room code element not found');
        roomCode = codeEl.innerText.trim();
        if (!roomCode || roomCode.length !== 6) throw new Error(`Invalid room code: ${roomCode}`);
        log(`Room created: ${roomCode}`);
      });

      if (!running || !roomCode) return showResults();

      // Test 5: Join Room
      await runTest('Join Room', async () => {
        const input = frame2.contentDocument.querySelector('input[placeholder="Enter Room Code"]');
        if (!input) throw new Error('Room code input not found');
        input.value = roomCode;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        await sleep(200);
        await clickButton(frame2, 'Join Room');
        // Wait for battle to start
        await waitForText(frame1, 'Your Moves', 15000);
        await waitForText(frame2, 'Your Moves', 15000);
        log('Both players joined battle!');
      });

      if (!running) return showResults();

      // Test 6: Select Moves and Fight
      await runTest('Move Exchange', async () => {
        // Find and click Charge buttons (Extended Range move)
        const findMoveButton = (frame, moveName) => {
          const buttons = frame.contentDocument.querySelectorAll('button');
          for (const btn of buttons) {
            if (btn.innerText.includes(moveName) && !btn.disabled) {
              return btn;
            }
          }
          return null;
        };

        const p1Move = findMoveButton(frame1, 'Charge');
        const p2Move = findMoveButton(frame2, 'Charge');

        if (!p1Move) throw new Error('Player 1 Charge button not found');
        if (!p2Move) throw new Error('Player 2 Charge button not found');

        p1Move.click();
        p2Move.click();
        await sleep(300);

        // Click FIGHT on both
        await clickButton(frame1, 'FIGHT');
        await clickButton(frame2, 'FIGHT');

        log('Both players clicked FIGHT, waiting for resolution...');

        // Wait for exchange to resolve (either see "Waiting" then result, or direct result)
        await sleep(3000);

        // Check if we see some result (round history or opponent used move)
        let resolved = false;
        for (let i = 0; i < 20; i++) {
          const text = frame1.contentDocument.body.innerText;
          if (text.includes('used') || text.includes('Round 1')) {
            resolved = true;
            break;
          }
          await sleep(500);
        }

        if (!resolved) {
          log('Exchange may still be pending, checking state...', 'warn');
        } else {
          log('Exchange resolved successfully!');
        }
      });

      showResults();
    }

    function stopTests() {
      running = false;
      log('Tests stopped by user', 'warn');
      showResults();
    }

    function showResults() {
      running = false;
      document.getElementById('runTests').disabled = false;
      document.getElementById('stopTests').disabled = true;

      const passed = testResults.filter(t => t.passed).length;
      const failed = testResults.filter(t => !t.passed).length;

      setStatus(failed === 0 ? `All ${passed} Tests Passed!` : `${passed} Passed, ${failed} Failed`,
                failed === 0 ? 'passed' : 'failed');

      const resultsEl = document.getElementById('results');
      const listEl = document.getElementById('resultsList');
      resultsEl.style.display = 'block';

      listEl.innerHTML = testResults.map(t => `
        <div class="test-result">
          <span class="icon">${t.passed ? '‚úÖ' : '‚ùå'}</span>
          <span class="name">${t.name}${t.error ? ` - ${t.error}` : ''}</span>
          <span class="time">${t.duration}ms</span>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
